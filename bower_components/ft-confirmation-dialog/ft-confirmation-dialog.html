<link rel="import" href="../polymer/polymer.html">

<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../marked-element/marked-element.html">

<link rel="import" href="../ft-scrolling-behavior/ft-scrolling-behavior.html">


<!--
`ft-confirmation-dialog`
A configurable confirmation dialog that returns a Promise when posed.

@demo demo/index.html
-->

<dom-module id="ft-confirmation-dialog">

    <template>

        <style include="iron-flex iron-flex-alignment iron-positioning"></style>

        <style>
            :host {
                display:block;
            }
        </style>

        <paper-dialog modal="" id="dialog" style="width:500px;">

            <!-- Prompt -->
            <div id="promptScroller" style="overflow:auto;">
                <marked-element id="prompt" markdown="[[_prompt]]">
                    <div class="markdown-html"></div>
                </marked-element>
            </div>

            <!-- Buttons -->
            <div id="buttons" class="layout horizontal end-justified">

                <!-- Cancel -->
                <paper-button id="cancelButton" dialog-dismiss="" raised="">
                    [[_cancelButtonLabel]]
                </paper-button>

                <div id="cancelButtonSpacer" style="width:20px"></div>

                <!-- Okay -->
                <paper-button dialog-confirm="" raised="" autofocus="">[[_commitButtonLabel]]</paper-button>
            </div>

        </paper-dialog>

    </template>

    <script>
        Polymer({

            is: 'ft-confirmation-dialog',

            behaviors: [
                Polymer.IronResizableBehavior,
                FtScrollingBehavior
            ],

            properties: {
                
                _prompt: {
                    type: String
                },
                
                _commitButtonLabel: {
                    type: String,
                    value: "Okay"
                },
                
                _cancelButtonLabel: {
                    type: String,
                    value: "Cancel"
                }
            },

            ready: function()
            {
                this._manageScroller(this.$.promptScroller)
            },

            _calculateScrollerHeight: function(scroller)
            {
                const buttonsHeight = this.$.buttons.offsetHeight;
                return this.clientHeight - buttonsHeight;
            },

            alert: function(prompt, commitButtonLabel)
            {
                this.$.cancelButton.hidden = true;
                this.$.cancelButtonSpacer.hidden = true;

                if (!!prompt)
                    this._prompt = prompt;
                else
                    this._prompt = "Alert";

                return this._pose(prompt, commitButtonLabel);
            },

            confirm: function(prompt, commitButtonLabel, cancelButtonLabel)
            {
                this.$.cancelButton.hidden = false;
                this.$.cancelButtonSpacer.hidden = false;

                if (!!prompt)
                    this._prompt = prompt;
                else
                    this._prompt = "Are you sure you want to do this?";

                if (!!cancelButtonLabel)
                    this._cancelButtonLabel = cancelButtonLabel;
                else
                    this._commitButtonLabel = "Cancel";

                return this._pose(prompt, commitButtonLabel);
            },

            _pose: function(prompt, commitButtonLabel)
            {
                // Override dumb default that disables Escape keyboard equivalent for cancel
                this.$.dialog.noCancelOnEscKey = false;

                if (!!commitButtonLabel)
                    this._commitButtonLabel = commitButtonLabel;
                else
                    this._commitButtonLabel = "Okay";

                return new Promise(function(resolve, reject)
                {
                    this.$.dialog.open();

                    this.doneListener = function doneListener(event)
                        {
                            this.$.dialog.removeEventListener("iron-overlay-closed", this.doneListener);

                            var choice;
                            const closingReason = event.detail;
                            if (closingReason.canceled || !closingReason.confirmed)  // Huh?
                                choice = "cancel";
                            else
                                choice = "commit";

                            resolve(choice);
                        }.bind(this);

                    this.$.dialog.addEventListener("iron-overlay-closed", this.doneListener)
                }.bind(this))
            }

        });
    </script>
</dom-module>
